name: Deploy to Sakura Server via SSH

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      # ====== å¿…é ˆSecretsï¼ˆSettings > Secrets and variables > Actionsï¼‰======
      SSH_HOST: ${{ secrets.SSH_HOST }}          # ä¾‹: www2225.sakura.ne.jp
      SSH_PORT: ${{ secrets.SSH_PORT }}          # ä¾‹: 22ï¼ˆçœç•¥å¯ï¼‰
      SSH_USER: ${{ secrets.SSH_USER }}          # ä¾‹: wellnoa
      REMOTE_PATH: ${{ secrets.REMOTE_PATH }}    # ä¾‹: /home/wellnoa/www

      DB_HOST: ${{ secrets.DB_HOST }}            # ä¾‹: mysql3109.db.sakura.ne.jp
      DB_NAME: ${{ secrets.DB_NAME }}            # ä¾‹: wellnoa_wellnoa
      DB_USER: ${{ secrets.DB_USER }}            # ä¾‹: wellnoa_wellnoa
      DB_PASS: ${{ secrets.DB_PASS }}            # ä¾‹: ********

      OPENWEATHER_API_KEY: ${{ secrets.OPENWEATHER_API_KEY }}
      ADMIN_USER: ${{ secrets.ADMIN_USER }}      # ä¾‹: admin
      ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}  # ä¾‹: ********

      APP_ENV:  ${{ secrets.APP_ENV }}           # ä¾‹: production
      BASE_URL: ${{ secrets.BASE_URL }}          # ä¾‹: https://wellnoa.sakura.ne.jp

    steps:
      - name: ðŸ§¾ Checkout
        uses: actions/checkout@v4

      - name: ðŸ” Setup SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: ðŸ§© Add host to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p "${SSH_PORT:-22}" "${SSH_HOST}" >> ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts

      - name: ðŸ§¹ Prepare rsync ignore rules
        run: |
          cat > .rsync-filter <<'EOF'
          - .git/
          - .github/
          - node_modules/
          - vendor/
          - **/.DS_Store
          - **/Thumbs.db
          EOF

      - name: ðŸ“¤ Rsync to remote
        run: |
          rsync -az --delete --filter='merge .rsync-filter' \
            -e "ssh -p ${SSH_PORT:-22}" \
            ./ "${SSH_USER}@${SSH_HOST}:${REMOTE_PATH}/"

      - name: âœï¸ Generate env.php on remote (with sakura_db_info function)
        run: |
          ssh -p "${SSH_PORT:-22}" "${SSH_USER}@${SSH_HOST}" "mkdir -p ${REMOTE_PATH}"
          ssh -p "${SSH_PORT:-22}" "${SSH_USER}@${SSH_HOST}" "cat > ${REMOTE_PATH}/env.php <<'PHP'
          <?php
          /**
           * Auto-generated by GitHub Actions. Do not commit this file.
           * æœ¬ç•ªã¨ãƒ­ãƒ¼ã‚«ãƒ«ã®ä¸¡å¯¾å¿œã®ãŸã‚ã€å®šæ•°ã¨é–¢æ•°ã®ä¸¡æ–¹ã‚’å®šç¾©ã—ã¾ã™ã€‚
           */

          // ====== ã‚¢ãƒ—ãƒªç”¨å®šæ•° ======
          if (!defined('APP_ENV'))  define('APP_ENV',  getenv('APP_ENV') ?: 'production');
          if (!defined('BASE_URL')) define('BASE_URL', getenv('BASE_URL') ?: '');

          // ====== DBå®šæ•°ï¼ˆé–¢æ•°ã‚’ä½¿ã‚ãªã„å®Ÿè£…å‘ã‘ï¼‰======
          if (!defined('DB_HOST')) define('DB_HOST', getenv('DB_HOST') ?: '');
          if (!defined('DB_NAME')) define('DB_NAME', getenv('DB_NAME') ?: '');
          if (!defined('DB_USER')) define('DB_USER', getenv('DB_USER') ?: '');
          if (!defined('DB_PASS')) define('DB_PASS', getenv('DB_PASS') ?: '');

          // ====== ãã®ã»ã‹ã®å®šæ•° ======
          if (!defined('OPENWEATHER_API_KEY')) define('OPENWEATHER_API_KEY', getenv('OPENWEATHER_API_KEY') ?: '');
          if (!defined('ADMIN_USER'))          define('ADMIN_USER', getenv('ADMIN_USER') ?: 'admin');
          if (!defined('ADMIN_PASSWORD'))      define('ADMIN_PASSWORD', getenv('ADMIN_PASSWORD') ?: '');

          // ====== äº’æ›ç”¨ï¼šsakura_db_info() ã‚’å¿…è¦ã¨ã™ã‚‹æ—¢å­˜ã‚³ãƒ¼ãƒ‰å‘ã‘ ======
          if (!function_exists('sakura_db_info')) {
            function sakura_db_info() {
              return [
                'db_name' => defined('DB_NAME') ? DB_NAME : '',
                'db_host' => defined('DB_HOST') ? DB_HOST : '',
                'db_id'   => defined('DB_USER') ? DB_USER : '',
                'db_pw'   => defined('DB_PASS') ? DB_PASS : '',
              ];
            }
          }
          PHP"

      - name: ðŸ”§ Post-deploy fixes
        run: |
          ssh -p "${SSH_PORT:-22}" "${SSH_USER}@${SSH_HOST}" "chmod 640 ${REMOTE_PATH}/env.php || true"
          ssh -p "${SSH_PORT:-22}" "${SSH_USER}@${SSH_HOST}" "touch ${REMOTE_PATH}/index.php || true"

      - name: âœ… Health check
        run: |
          echo "Deployed to ${BASE_URL:-<set BASE_URL secret>}"